/*
 *  Project: jQuery Cloner
 *  Description: form cloner with unlimited levels
 *  Author: Girolamo Tomaselli http://bygiro.com
 *  License: GNU General Public License
 */
;!function(a,b,c,d){"use strict";var e="cloner",f="plugin_"+e,g={group:"",max:999,cloneThis:".toclone",itemsContainer:".items_container",dataClone:!0,deepClone:!0,editButton:".edit",editForm:".editForm",cloneButton:".clone",deleteButton:".delete",clonePosition:"after",confirmationOnDelete:!1,enableJSONfields:!0,targetField:null,data:[],hash:!1,text:{are_you_sure_to_delete:"Are you sure to delete it?"},onMaxReached:!1,onBeforeDelete:!1,onAfterDelete:!1,onClone:!1,onBeforeEdit:!1,onAfterEdit:!1,onSetClonerIds:!1,onInit:!1},h=function(b,d){var e=a.Event(b),f=this.options.events[b];return d instanceof Array||(d=[d]),d.unshift(this),a(c).triggerHandler(e,d),this.options.$element.triggerHandler(e,d),"function"==typeof f?f.call(this,d):!0},i=function(){var c=this.options;c.$element.find(c.editButton).length>0&&c.$element.off("click",c.editButton),c.$element.find(c.cloneButton).length>0&&c.$element.off("click",c.cloneButton),c.$element.find(c.deleteButton).length>0&&c.$element.off("click",c.deleteButton),c.$element.find("input,select,textarea").length>0&&c.$element.off("click change keyup","input,select,textarea")},j=function(){var b=this,c=this.options;c.$element.on("click",c.editButton,function(c){c.preventDefault(),c.stopPropagation(),b.edit(a(this))}),c.$element.on("click",c.cloneButton,function(c){c.preventDefault(),c.stopPropagation(),b.clone(a(this))});var d=c.$element.find(".security_lock_delete").first();if(c.$element.on("click",c.deleteButton,function(e){e.preventDefault(),e.stopPropagation();var f=!0;(d.prop("checked")||d.is(":checked"))&&c.confirmationOnDelete&&(f=confirm(c.text.are_you_sure_to_delete)),f&&b.delete(a(this))}),c.enableJSONfields&&c.targetField){var e=function(a){k(function(){var a=b.getData(!0);c.$element.parent().find(c.targetField).val(JSON.stringify(a))},a)};c.$element.on("cloner_after_clone cloner_after_delete",function(){e.call(this,50)}),c.$element.on("change click keyup","input,select,textarea",function(a){var d,b=this,f=(jQuery(this).attr("name"),jQuery(this).get(0).tagName),g=jQuery(this).attr("type");g="undefined"!=typeof g?"_"+g:"";var h=f+g,h=h.toLowerCase(),i=20;switch(h){case"select":case"input_hidden":case"input_file":d="change";break;case"input_radio":case"input_checkbox":d="click";break;case"input_text":case"textarea":default:d="keyup",i=200}if(a.type==d){var j=jQuery(b).closest("[data-cloner-id]");j.length>0&&n(j),e.call(b,i)}})}},k=function(){var a=0;return function(b,c){clearTimeout(a),a=setTimeout(b,c)}}(),l=function(b){var c=this,d=0,f=this.options,g=m(f.$element),i=f.$element.find(f.cloneThis),b="undefined"!=typeof b&&b?!0:!1;i.each(function(){a(this).attr("data-cloner-id",d),a(this).replaceWith(o(a(this),d,g)),b&&a(this).find("[data-cloner-hash]").each(function(){return"undefined"==typeof a(this).data("plugin_cloner")?!0:(a(this).cloner("setClonerIds"),void 0)}),d++}),h.call(c,e+"_set_cloner_ids")},m=function(a){var b=u(a),c=b.shift();return b.length>0&&(c+="["+b.join("][")+"]"),c},n=function(b,c){var d=b.parents("[data-cloner-hash]").length;b instanceof jQuery&&("undefined"==typeof c&&(c=v(b,!1,!0,!0)),b.find("[data-cloner-field]").each(function(){var b=a(this).attr("data-cloner-field"),e=a(this).parents("[data-cloner-hash]").length,f=c[b]||"";return c[b]instanceof Array&&a.isPlainObject(c[b][0])?!0:(c[b]instanceof Array&&(f=c[b].join(", ")),e!=d?!0:(a(this).html(f),void 0))}))},o=function(b,c,d,e){var f=b.parents("[data-cloner-hash]").length;if(n(b,e),"undefined"==typeof c||!r(c)){var c=parseInt(b.closest("[data-cloner-id]").attr("data-cloner-id"));r(c)||(c=0)}var g=b.attr("data-cloner-id");return"undefined"!=typeof g&&""!=g&&b.attr("data-cloner-id",c),b.find("[id],[for],[href^=#],[name],[data-cloner-index]").each(function(){var b=a(this).parents("[data-cloner-hash]").length;if(b!=f)return!0;for(var e=["id","for","href","name","data-cloner-index"],g=0;g<e.length;g++){var h=e[g],i=a(this).attr(h);if("undefined"!=typeof i&&""!=i){var j=a(this).attr("data-original-"+h);switch(h){case"id":case"for":case"href":var k=j;j||(a(this).attr("data-original-"+h,i),k=i),a(this).attr(h,k+"_"+c);break;case"name":if("undefined"!=typeof d&&""!==d){var l="["+t(i)+"]";i.indexOf("[]")>=0&&(l+="[]"),i=d+"["+c+"]"+l}else{var m=i.match(/^(.*)\[(\d)\](.*)/i);m&&4===m.length&&(i=m[1]+"["+c+"]"+m[3])}a(this).attr(h,i);break;case"data-cloner-index":a(this).attr(h,c+1),a(this).html(c+1)}}}}),b},p=function(a,b){var c,d,e=!1,f=a.closest("[data-cloner-hash]");if("undefined"==typeof f.data("plugin_cloner"))return!1;d=f.data("plugin_cloner"),c=d.options;var g=a.attr("data-item-index");if(!g){var h=a.closest(c.cloneThis);h.length>0&&(g=c.$element.find(c.cloneThis).index(h))}switch(b){case"edit":z.call(d,g);break;case"clone":e=x.call(d,g);break;case"remove":e=y.call(d,g)}return e},q=function(){var a=this.options.$element.attr("class"),b=a+this.options.$element.attr("id")+this.options.cloneThis+this.options.editButton+this.options.cloneButton+this.options.deleteButton,c=Math.abs(b.hashCode());return this.options.hash=c,c},r=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},s=function(a,b,c,e){var b=b instanceof Array?b:b.split("."),f=a,e="undefined"==typeof e?"get":e;b=b.filter(function(a){return a!=d&&""!=a});for(var g=0;g<b.length-1;g++){if("undefined"==typeof f[b[g]]){if("set"!=e)return null;f[b[g]]=r(b[g])?[]:{}}f=f[b[g]]}return"set"==e&&(f[b[b.length-1]]=c),"remove"!=e?f[b[b.length-1]]:(delete f[b[b.length-1]],void 0)},t=function(a){if(a.indexOf("[")>=0){var b=a.split("["),a=b.pop().replace("]","");("undefined"==typeof a||""==a)&&(a=b.pop().replace("]",""))}return a},u=function(b){var c=[];return b.parents("[data-cloner-group],[data-cloner-id]").add(b).each(function(){var b=a(this).parents("[data-cloner-group],[data-cloner-id]").length,d=a(this).attr("data-cloner-group"),e=a(this).attr("data-cloner-id");"undefined"!=typeof d&&""!==d?c[b]=d:"undefined"!=typeof e&&""!==e&&(c[b]=e)}),c},v=function(b,c,d,e){var f;d="undefined"!=typeof d?d:!0,e="undefined"!=typeof e?e:!1,f=b.serializeObject(d,e);var g=u(b);return c&&b.find("[data-cloner-hash]").each(function(){var b=a(this).parents("[data-cloner-hash]").length,c=a(this).attr("data-cloner-group");if("undefined"==typeof c||""==c)return!0;var d=u(a(this)),e=[];a(this).find("[data-cloner-id]").each(function(){var c=a(this).parents("[data-cloner-hash]").length;if(c!=b+1)return!0;var d=v(a(this),!0);a.isPlainObject(d)&&!a.isEmptyObject(d)&&e.push(d)});var h=g.join("."),i=d.join(".");d=0==i.indexOf(h)?i.replace(h,"").split("."):d;var j="set";0==e.length&&(j="remove"),s(f,d,e,j)}),f},w=function(b,c){b.find("select,input,textarea").each(function(){var g,h,d=a(this),e=this.name,f=t(e),i=d.get(0).tagName,j=d.attr("type");if(""==f)return!0;switch(h=null,"undefined"!=typeof c[f]&&(h=c[f]),"boolean"==typeof c[f]&&(h=0,c[f]&&(h=1)),j="undefined"!=typeof j?"_"+j:"",g=i+j,g=g.toLowerCase()){case"input_radio":case"input_checkbox":if("input_radio"==g){var k=d.parent().find('[name="'+e+'"]'),l=[0,1];2==k.length&&(k.each(function(){var b=l.indexOf(parseInt(a(this).val()));b>=0&&delete l[b]}),0==l.length&&(h||(h=0)))}var m=d.val();!(h instanceof Array)&&h==m||a.inArray(m.toString(),h)>=0||null===h&&0===m?d.prop("checked",!0).attr("checked","checked"):d.prop("checked",!1).removeAttr("checked");break;default:d.val(h)}})},x=function(c,d){var j,k,f=[],g=[],i=!1,d="undefined"!=typeof d?d:"add",m=this,n=this.options,p=n.$element.find(n.cloneThis),q=r(c);switch(!0){case a.isPlainObject(c):g=[c],c=null;break;case a.isArray(c)&&a.isPlainObject(c[0]):g=c,c=null;break;case q:break;default:c=null}q=r(c),j=p.first();var t=this.options.$element.parent().find("."+this.options.hash);if(t.length&&(j=t.first().children().length?t.first().children():a(t.first().html())),q&&(j=p.eq(c)),p.length>=n.max)return h.call(m,e+"_max_reached",[j]),void 0;if(h.call(m,e+"_before_clone",[j])){k=j.clone({withDataAndEvents:n.dataClone,deepWithDataAndEvents:n.deepClone});var x=v(j,!0);g.length<=0&&(g=[x],i=!0);var y=k.wrap("<div>").parent().html();g.reverse();var z=0;"replace"!=d&&q&&(z=c+1),a.each(g,function(c,d){var e,g=a(y);e=a.isPlainObject(d)&&!a.isEmptyObject(d),e&&w(g,d),g=o.call(m,g,z,d);var h="after";"after"!=n.clonePosition&&(h="before"),i&&q?j[h](g):1==p.last().length?p.last()[h](g):n.$element.find(n.itemsContainer).prepend(g);var k=n.$element.find(n.cloneThis).index(g);g=n.$element.find(n.cloneThis).eq(k);var l=u(g);g.find("[data-cloner-hash]").each(function(){var e=a(this).attr("data-cloner-hash"),f=a(this).attr("data-cloner-group");if("undefined"==typeof e||""==e)return!0;var g=b.cloner[e].options,h=[];if(""==f)return!0;h=u(a(this));var i=l.join("."),j=h.join(".");h=0==j.indexOf(i)?j.replace(i,"").split("."):h;var k=s(d,h);k instanceof Array&&(g.data=k),a(this).cloner(g)}),f.push(z),z++}),"replace"==d&&p.remove(),l.call(m,!0);var A=n.$element.find(n.cloneThis),B=f.shift(),C=f.pop();return C>0?C+=1:C=A.length+1,A.slice(B,C),h.call(m,e+"_after_clone",[j,A]),A}},y=function(b){if("undefined"==typeof b)return!0;var d=this,f=this.options,g=f.$element.find(f.cloneThis);if(h.call(d,e+"_before_delete",[g])){if(a.isArray(b))g.length-b.length<=1?g.slice(0,g.length).remove():g.remove();else{if(""===b)return!1;g.eq(parseInt(b)).remove()}return h.call(d,e+"_after_delete",[b]),!0}},z=function(a){var b=this,c=this.options,d=c.$element.find(c.cloneThis),f=null;if("undefined"!=typeof a&&a>=0&&(f=d.eq(parseInt(a))),"undefined"!=typeof c.editingProcess[a])return f&&f.find(c.editForm).hide(),delete c.editingProcess[a],h.call(b,e+"_after_edit",[a]),void 0;if(h.call(b,e+"_before_edit",[a])){if(!f||0==f.length)return x.call(b),void 0;f.find(c.editForm).show(),c.editingProcess[a]=!0}};a.fn.serializeObject=function(b,c){var g,e=this,f=this.parents("[data-cloner-hash]").length,b="undefined"!=typeof b&&b?!0:!1,h={};return g=this.find("input,textarea,select").filter(function(){var b=a(this).parents("[data-cloner-hash]").length;return b!=f?!1:!0}).serializeArray(),a.each(g,function(){var i=this.name;b&&(i=t(i));var j=this.value;if(c){var k=e.find('[name="'+this.name+'"]');if(k.is("select"))if(a.isArray(j))for(var l=0;l<j.length;l++){var m=k.find('option[value="'+j[l]+'"]');m.length>0&&(j[l]=m.html())}else j=k.find('option[value="'+j+'"]').html();else if(k.first().is('[type="checkbox"],[type="radio"]'))if(a.isArray(j))for(var l=0;l<j.length;l++){var n=k.filter(function(){return a(this).is('[value="'+j[l]+'"]')?!0:!1}).attr("id"),o=e.find('label[for="'+n+'"]');n&&o&&(j[l]=o.html())}else{var n=k.filter(function(){return a(this).is('[value="'+j+'"]')?!0:!1}).attr("id"),o=e.find('label[for="'+n+'"]');n&&o&&(j=o.html())}}h[i]!==d?(h[i].push||(h[i]=[h[i]]),h[i].push(j||"")):h[i]=j||""}),h},String.prototype.hashCode=function(){var b,c,d,a=0;if(0==this.length)return a;for(b=0,d=this.length;d>b;b++)c=this.charCodeAt(b),a=(a<<5)-a+c,a|=0;return a};var A=function(b){var c={};c[e+"_max_reached"]="onMaxReached",c[e+"_set_cloner_ids"]="onSetClonerIds",c[e+"_initialized"]="onInit",c[e+"_before_edit"]="onBeforeEdit",c[e+"_after_edit"]="onAfterEdit",c[e+"_before_clone"]="onBeforeClone",c[e+"_after_clone"]="onAfterClone",c[e+"_before_delete"]="onBeforeDelete",c[e+"_after_delete"]="onAfterDelete",this.others_opts={events:c,initialized:!1,editingProcess:{},$element:a(b)},this.options=a.extend({},g)};A.prototype={init:function(c){if(!this.options.initialized){var d={},f=this.others_opts.$element.data();for(var g in this.options)"undefined"!=typeof f[g]&&(d[g]=f[g]);if("undefined"!=typeof f.targetField&&""!=a(f.targetField).val())try{d.data=JSON.parse(a(f.targetField).val())}catch(i){}if(a.extend(this.options,d,c,this.others_opts),this.options.hash||q.call(this),!this.options.$element.parent().find("."+this.options.hash).length){var k=this.options.$element.find(this.options.cloneThis).first().clone(!0).wrap("<div/>").parent().html();k=a('<script type="text/xml" class="'+this.options.hash+'"/>').html(k),this.options.$element.before(k)}this.options.$element.addClass("cloner_container"),this.options.$element.attr("data-cloner-hash",this.options.hash),""!=this.options.group&&this.options.$element.attr("data-cloner-group",this.options.group),"undefined"==typeof b.cloner&&(b.cloner={}),"undefined"==typeof b.cloner[this.options.hash]&&(b.cloner[this.options.hash]={},b.cloner[this.options.hash].options=this.options),l.call(this),j.call(this),this.options.enableJSONfields&&0==this.options.$element.find(".clonerContainer:not([data-cloner-hash])").not(this.options.$element).length&&this.options.$element.find(this.options.cloneThis).remove(),this.options.data.length>0&&x.call(this,this.options.data,"replace"),this.options.initialized=!0,h.call(this,e+"_initialized",[])}},setData:function(a,b){var c=this;b="undefined"==typeof b?"replace":b,"undefined"==typeof a||a.length<=0||("string"==typeof a&&(a=JSON.parse(a)),x.call(c,a,b))},setClonerIds:function(a){l.call(this,a)},getData:function(b){var d=this.options,e=[];return b="undefined"!=typeof b&&b?!0:!1,d.$element.find(this.options.cloneThis).each(function(){var c=v(a(this),b);a.isPlainObject(c)&&!a.isEmptyObject(c)&&e.push(c)}),e},clone:function(a){p(a,"clone")},edit:function(a){p(a,"edit")},"delete":function(a){p(a,"remove")},destroy:function(){this.options.$element.removeClass("cloner_container").removeAttr("data-cloner-hash").removeAttr("data-cloner-group"),this.options.$element.find(this.options.cloneThis).removeAttr("data-cloner-id"),i.call(this),this.element.data(f,null)}},a.fn[e]=function(b){var c,d;if(this.length<=0)return this;if(this.data(f)instanceof A||this.data(f,new A(this)),d=this.data(f),d.element=this,"undefined"==typeof b||"object"==typeof b)"function"==typeof d.init&&d.init(b);else{if("string"==typeof b&&"function"==typeof d[b])return c=Array.prototype.slice.call(arguments,1),d[b].apply(d,c);a.error("Method "+b+" does not exist on jQuery."+e)}}}(jQuery,window,document);