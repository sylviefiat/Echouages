/*
* @project		tags manager jQuery plugin
* @version		0.0.1
* @package		jForms
* @copyright	G. Tomaselli
* @author		Girolamo Tomaselli - http://bygiro.com - girotomaselli@gmail.com
* @license		GNU GPL v3 or later
*/
;!function(a){function c(){for(var a,b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",c=0;5>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}function d(b){var c=[];return a.each(b,function(b,d){-1==a.inArray(d,c)&&c.push(d)}),c}var b={init:function(d){return this.each(function(){var e=this,f=a(this),g=f.data("tgMan");if("undefined"==typeof g){var h=f.attr("id"),i={capitalizeFirstLetter:"false"==f.attr("data-capitalize-first-letter")?!1:!0,max:f.attr("data-max")>0?f.attr("data-max"):0,separator:""!=f.attr("data-separator")?f.attr("data-separator"):",",typeahead:!0,sourceTagsClass:"tgMan",typeaheadSourceFunction:function(){return jQuery("#"+f.attr("id")).tagsManagerByGiro("sourceTags")},validation:function(){return!0},fakeInputId:"FAKE-"+h};g=a.extend({},i,d),f.data("tgMan",g)}else g=a.extend({},g,d);if(0==f.length||!f.is('input[type="text"], textarea'))return f;if(f.hide().addClass("tgMan"),"FAKE-"==g.fakeInputId||""==g.fakeInputId||a("#"+g.fakeInputId).length>1){for(var j=c();a("#FAKE-"+j).length>0;)j=c();g.fakeInputId="FAKE-"+j}var k;if(f.next().hasClass("tgMan-fake-input")){var l=f.next().attr("id");""==l?f.next().attr("id",g.fakeInputId):g.fakeInputId=l,k=f.next()}else{var k=jQuery('<input type="text" id="'+g.fakeInputId+'" class="tgMan-fake-input"/>');f.after(k)}f.prev().hasClass("tags-container")?f.prev().html(""):f.before('<span class="tags-container"></span>');var m=f.val();m=m.split(g.separator);var n=new Array;f.data("tgMan-tagsList",n),a.each(m,function(a,c){b.addTag.call(e,c)}),n=f.data("tgMan-tagsList");var o=n.join(g.separator);f.val(o).attr("value",o),g.typeahead&&k.typeahead({source:g.typeaheadSourceFunction,updater:function(a){b.addTag.call(e,a)}}),k.on("keydown",function(a){var c=k.val();switch(a.which){case 13:case 9:k.next().hasClass("typeahead")&&k.next().is(":visible")&&g.typeahead||(a.preventDefault(),""!=c&&b.addTag.call(e,c))}}),k.on("blur",function(){var a=k.val();k.next().hasClass("typeahead")&&k.next().is(":visible")&&g.typeahead||""!=a&&b.addTag.call(e,a)})})},addTag:function(c){var d=this,e=a(this);opts=e.data("tgMan");var f=[];if("string"==typeof c?f=c.split(opts.separator):"array"==typeof c&&(f=c),f.length>1)return a.each(f,function(a,c){b.addTag.call(d,c)}),void 0;var g=a.trim(c);if(tagsList=e.data("tgMan-tagsList"),!(opts.max>0&&tagsList.length>=opts.max||!g||g.length<=0)){if(opts.capitalizeFirstLetter&&(g=g.charAt(0).toUpperCase()+g.slice(1).toLowerCase()),fakeInput=e.parent().find("#"+opts.fakeInputId),a.inArray(g,tagsList)>=0)return fakeInput.val("").attr("value",""),void 0;if("function"!=typeof opts.validation||opts.validation(g)){var h=a("<span></span>").text(g).html(),i='<span tag="'+h+'" class="tm-tag">';i+="<span>"+h+"</span>",i+="<a href=\"#\" onclick=\"jQuery(this).closest('.tags-container').parent().find('#"+e.attr("id")+"').tagsManagerByGiro('removeTag','"+h+'\'); return false;" class="tm-tag-remove">&times;</a></span>';var j=a(i);e.prev().append(j),tagsList.push(g),opts.max>0&&tagsList.length>=opts.max&&fakeInput.hide(),fakeInput.val("").attr("value","");var k=tagsList.join(opts.separator);e.val(k).attr("value",k).trigger("keyup"),e.data("tgMan-tagsList",tagsList)}}},removeTag:function(c){var d=this,e=a(this);opts=e.data("tgMan");var f=[];if("string"==typeof c?f=c.split(opts.separator):"array"==typeof c&&(f=c),f.length>1)return a.each(f,function(a,c){b.removeTag.call(d,c)}),void 0;if(tagsList=e.data("tgMan-tagsList"),"undefined"==typeof c||c.length<=0)var c=tagsList[tagsList.length-1];if(!("undefined"==typeof c||c.length<=0)){e.prev().find('[tag="'+c+'"]').remove(),tagsList.splice(a.inArray(c,tagsList),1),fakeInput=e.parent().find("#"+opts.fakeInputId),opts.max>0&&tagsList.length<opts.max&&fakeInput.show();var g=tagsList.join(opts.separator);e.val(g).attr("value",g).trigger("keyup"),e.data("tgMan-tagsList",tagsList)}},tagsList:function(){var b=a(this).data("tgMan-tagsList");return b},sourceTags:function(b){var e=a(this);opts=e.data("tgMan"),"undefined"==typeof b&&(b=opts.sourceTagsClass);var f=[];jQuery("body").find("."+b).each(function(){var b=a(this).tagsManagerByGiro("tagsList");"undefined"!=typeof b&&b.length>0&&(f=a.merge(f,b))});var g=d(f);return g.length>0?g:null}};a.fn.tagsManagerByGiro=function(c){return b[c]?b[c].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof c&&c?(a.error("Method "+c),void 0):b.init.apply(this,arguments)}}(jQuery);