/*
 *  Project: jQuery condRules
 *  Description: it performs show/hide (and not only) task on DOM elements based on form input values
 *  Author: Girolamo Tomaselli http://bygiro.com
 *  License: GNU General Public License
 */
;!function(t,e,i,n){"use strict";var o="condRules",s=function(e,n){var o=t.Event(e),s=this.events[e];return n instanceof Array||(n=[n]),n.unshift(this),t(i).triggerHandler(o,n),this.element.triggerHandler(o,n),"function"==typeof s?s.call(this,n):!0},a=function(){},r=function(e){var i=this;t.each(e,function(e,o){if(t.isEmptyObject(o))return!0;l.call(i,o);var s=t();for(var a in o){s=o[a].trigger;break}return 0==s.length?!0:(s.on("keyup change click",function(s){var a,r=1200,d=!1,p=t(this),c=p.get(0).tagName,u=p.attr("type");switch(u=n!==u?"_"+u:"",a=c+u,a=a.toLowerCase()){case"select":case"input_hidden":case"input_file":"change"==s.type&&(d=!0,r=50);break;case"input_radio":case"input_checkbox":"click"==s.type&&(d=!0,r=50);break;case"input_text":case"textarea":default:"keyup"==s.type&&(d=!0)}d&&h(function(){l.call(i,o)},r,e)}),n)})},l=function(i,a,r){var d=this,a=n!==a?a:!1;if(!t.isEmptyObject(i)){(n!==i.trigger||n!==i.target)&&(i={whatever:i});for(var p in i){{var c=!1,u=i[p],h=u.target,f=u.trigger;u.task}f.each(function(){var e,i=t(this),o=i.get(0).tagName,s=i.attr("type");s=n!==s?"_"+s:"",e=(o+s).toLowerCase();var a=i.val();n!==a&&a&&""!=a||(a=[]),a instanceof Array||"string"!=typeof a||(a=[a]);var r=!0,l=a.length>0;if(("input_radio"==e||"input_checkbox"==e)&&(r=l=i.is(":checked")||i.prop("checked")),u.values.length||0!=a.length){if(u.values.length)if(u.values.indexOf("*")<0){for(var d=0;d<a.length;d++)if(u.values.indexOf(a[d])>=0){c=r;break}}else c=l}else c=!0;return c?!1:n});var m=u.target.data("condRulesData");if((u.or&&!c||!u.or&&c)&&m&&n!==m[u.task]&&(n===r||r))for(var g in m[u.task]){var v=m[u.task][g];if(v.hash!=u.hash)if(c=l.call(d,v,!0,!1)){if(u.or)break}else if(!u.or)break}if(a)return c;var y="_matched";if(c||(y="_unmatched"),s.call(this,o+y,[u]),d.defaultTasks.indexOf(u.task)<0)return"function"==typeof t.fn[u.task]?t[u.task](u,c):"function"==typeof e[u.task]&&e[u.task](u,c),n;var _=h;h.is("select,input,textarea")||(_=h.find("select,input,textarea"));var k=["hide","slideup","deselect"];k.indexOf(u.task)<0||(c=!c);var b,w=["show","hide","slidedown","slideup"],x=!1;t.isArray(u.taskValues)&&u.taskValues.length&&(x=u.taskValues,b=x.indexOf("*")>=0),_.each(function(){var e=t(this);if(w.indexOf(u.task)<0){if(!x)return!0;if(e.is("select")){if(b){var i=[];e.find("options").each(function(){i.push(t(this).attr("value"))}),x=i}var o=e.val(),s=t.isArray(o);s||(o=""!=o?[o]:[]),o=t.map(o,function(t){return x.indexOf(t)<0?t:n}),1==c&&(o=o.concat(x)),e.val(o).trigger("change")}else if(e.is('input[type="checkbox"],input[type="radio"]')){if(!b&&x.indexOf(e.val())<0)return!0;1!=c?e.prop("checked",!0).attr("checked","checked"):e.prop("checked",!1).removeAttr("checked"),e.trigger("click")}else if(1==c)e.val(x.join(" "));else{for(var a=e.val(),r=0;r<x.length;r++)a=a.replace(x[r],"");e.val(a)}}else{if(e.hasClass("condRulesExcludeDisabled"))return!0;if(e.is("select"))x?e.find("option").each(function(){return!b&&x.indexOf(t(this))<0?!0:(t(this).prop("disabled",!0).attr("disabled","disabled").addClass("invalid"),1==c&&t(this).prop("disabled",!1).removeAttr("disabled").removeClass("invalid"),n)}):(e.prop("disabled",!0).attr("disabled","disabled"),1==c&&e.prop("disabled",!1).removeAttr("disabled"));else{if(x&&e.is('input[type="checkbox"],input[type="radio"]')&&!b&&x.indexOf(e.val())<0)return!0;1==c?e.prop("disabled",!1).removeAttr("disabled"):e.prop("disabled",!0).attr("disabled","disabled")}}}),w.indexOf(u.task)<0||(1!=c?"show"==u.task||"hide"==u.task?h.hide():h.slideUp():"show"==u.task||"hide"==u.task?h.show():h.slideDown())}}},d=function(e){var i,n,o,s,a=this,r="",l="";return i=e.element.closest(".formFieldsContainer"),i.length>0||(i=e.element.closest("form")),i.length>0||(i=t("body")),s="this"==e.trigger?e.element:i.find(e.trigger),s.length>0?(n=s.get(0).tagName||"",n=n.toLowerCase(),o=s,t.inArray(n,a.formElements)<0&&(o=s.find(a.formElements.join(","))),e.trigger=o,e.trigger.each(function(){l+=t(this).get(0).tagName,l+=t(this).attr("id"),l+=t(this).attr("class"),l+=t(this).attr("type"),l+=t(this).text()}),e.triggerHash=l,e.target.each(function(){r+=t(this).get(0).tagName,r+=t(this).attr("id"),r+=t(this).attr("class"),r+=t(this).attr("type"),r+=t(this).text()}),r+=e.task,e.taskValues&&(r+=JSON.stringify(e.taskValues)),r+=JSON.stringify(e.values),e.hash=r,e):!1},p=function(e){var i,o={},s=e.substring(9,e.length-1);return s=s.split(","),s.length<3?!1:(o.or=n!==s[4]&&parseInt(s[4])>0?!0:!1,o.task=s[0].toLowerCase().trim(),""==o.task?!1:(o.trigger=s[1].split("|"),o.trigger=t.map(o.trigger,function(t){return t=t.trim(),""!=t?t:n}),0!=o.trigger.length?(o.trigger=o.trigger.join(","),o.values=s[2].split("|"),o.values=t.map(o.values,function(t){return t.trim()}),i=o.task.indexOf("("),0>i||(o.taskValues=o.task.substring(i+1,o.task.length-1).split("|"),o.taskValues=t.map(o.taskValues,function(t){return t.trim()}),o.task=o.task.substring(0,i)),o):n))},c=function(){var e=this,i={},o=t(),s='[class^="condRule["], [class*=" condRule["], [cond-rules], [cond-rule-task]';return this.element.each(function(){var e=t(this),i=e.find(s);e.is(s)?o=o.add(e):i.length>0&&(o=o.add(i))}),o.each(function(){var o,s=t(this),a=t(this),r=a.get(0).tagName,l=a.data(),c=a.attr("class").split(" "),u=[];if(r=r.toLowerCase(),t.inArray(r,e.formElements)>=0||a.hasClass("form-widget")){var h=a.closest(".control-group");h.length>0&&(s=h)}for(var f=0;f<c.length;f++){var m=c[f];if(m.indexOf("condRule[")>=0){var g,v=p.call(e,m);v&&(v.element=a,v.target=s,g=d.call(e,v),g&&u.push(g))}}n!==l.condRuleTask,a.data("cond-rules"),o=s.data("condRulesData"),o&&t.isPlainObject(o)||(o={});for(var y=0;y<u.length;y++){var g=u[y];n===i[g.triggerHash]&&(i[g.triggerHash]={}),i[g.triggerHash][g.hash]=g,t.isPlainObject(o[g.task])||(o[g.task]={}),o[g.task][g.hash]=g}s.data("condRulesData",o)}),i},u={},h=function(){return function(t,e,i){i=i||0,n!==u[i]&&clearTimeout(u[i]),u[i]=setTimeout(t,e)}}(),f=function(e){0==typeof e.length&&(e=t("body")),this.element=e,this.formElements=["input","select","textarea"],this.defaultTasks=["show","hide","slideup","slidedown","select","deselect"],this.events={},this.events[o+"_initialized"]="onInit"};f.prototype={init:function(){r.call(this,c.call(this)),s.call(this,o+"_initialized",[])},execRule:function(t){h(function(){l.call(this,t)},100,t.triggerHash)},checkRule:function(t,e){return l.call(this,t,!0,e)},getRules:function(){return c.call(this)},destroy:function(){a.call(this)}},t.fn[o]=function(e){var i,s;if(s=new f(this),n===e||"object"==typeof e)"function"==typeof s.init&&s.init(e);else{if("string"==typeof e&&"function"==typeof s[e])return i=Array.prototype.slice.call(arguments,1),s[e].apply(s,i);t.error("Method "+e+" does not exist on jQuery."+o)}return this}}(jQuery,window,document),jQuery(document).ready(function(){jQuery("form").each(function(){jQuery(this).condRules()})});