/** @name			Address Picker ByGiro jQuery plugin* @version		0.0.1* @package		jForms* @copyright	G. Tomaselli* @author		Girolamo Tomaselli - http://bygiro.com - girotomaselli@gmail.com* @license		GNU GPL v3 or later*/;!function(t,e,i,o){"use strict";var n="addressPickerByGiro",s="plugin_"+n,a={latitude:51.751724,longitude:-1.255284,zoom:2,mapType:"ROADMAP",mode:"modal",distanceWidget:!1,distanceWidgetType:"circle",distanceWidgetRadius:3e4,map:null,map_options:{zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL}},maxResultShow:10,markerType:"",markerLabelClass:"youarehere",cssSelectorTarget:null,targets_prefix:null,language:"en",text:{genericerror:"Sorry, something went wrong. Try again!",cancel:"Cancel",ok:"Ok",edit:"Edit",search:"Search",you_are_here:"You are here!",noresults:"Sorry! We couldn't find the address for the specified terms. Try a different search term, or click the map.",toofar:"Woah... that's pretty remote! You're going to have to manually enter a place name.",set_your_address:"Set your address",set_your_address_info:"You can search for an address or click on the map and drag the marker."},onInit:!1,onOpenModal:!1,onCancelModal:!1,onSuccess:!1,onViewportChanged:!1},r=function(){for(var t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;7>i;i++)t+=e.charAt(Math.floor(Math.random()*e.length));return t},l=function(){var t={};return function(e,i,o){clearTimeout(t[o]),t[o]=setTimeout(e,i)}}(),d=function(){switch(this.options.mode){case"modal":var e="";this.options.isElementInput||(e+='<a id="'+this.options.userInputId+'_edit" href="#" onclick="return false;" style="margin-left: 5px;" class="btn btn-primary btn-mini">'+this.options.text.edit+"</a>",t(e).insertAfter(this.element)),e='<div id="'+this.options.userInputId+'_modal" class="modal addresspicker hide fade '+this.options.aPicker+'" tabindex="-1" role="dialog" aria-labelledby="'+this.options.userInputId+'Label" aria-hidden="true">',e+='	<div class="modal-header">',e+='		<a href="#" onclick="return false;" class="close" data-dismiss="modal" aria-hidden="true">&times;</a>',e+='		<h3 id="'+this.options.userInputId+'Label">'+this.options.text.set_your_address+"</h3>",e+='		<span class="info">'+this.options.text.set_your_address_info+"</span>",e+="	</div>",e+='	<div class="modal-body" style="overflow:hidden;">',e+='  		<input autocomplete="off" id="'+this.options.pickerInputId+'" style="width: 80%;"/>',e+='		<a id="'+this.options.userInputId+'_search" href="#" onclick="return false;" class="btn btn-mini btn-success">'+this.options.text.search+"</a>",e+='		<br /><span id="'+this.options.userInputId+'_error"></span>',e+='		<div class="map_container">',e+='			<div id="'+this.options.map_id+'" class="picker_map"></div>',e+="		</div>",e+="	</div>",e+='	<div class="modal-footer">',e+='		<span onclick="return false;" class="btn" data-dismiss="modal" aria-hidden="true">'+this.options.text.cancel+"</span>",e+='		<span id="'+this.options.userInputId+'_ok" onclick="return false;" data-dismiss="modal" aria-hidden="true" class="btn btn-primary">'+this.options.text.ok+"</span>",e+="	</div>",e+="</div>",t("body").append(e);break;case"plain":default:this.element.css("margin-bottom","0");var e="";this.options.isElementInput||(e+='<input type="text" value="" id="'+this.options.userInputId+'" />'),e+='<span id="'+this.options.userInputId+'_search" class="picker_search_btn btn btn-mini btn-success '+this.options.aPicker+'">'+this.options.text.search+"</span><br />",e+='<span class="info">'+this.options.text.set_your_address_info+"</span>",e+='<span id="'+this.options.userInputId+"_error "+this.options.aPicker+'"></span>',e+='<div class="map_container '+this.options.aPicker+'">',e+='<div class="picker_map" id="'+this.options.map_id+'"></div>',e+="</div>",t(e).insertAfter(this.element)}},p=function(){t("#"+this.options.map_id).is(":visible")&&(this.resizeMap(),this.options.map_visible=e.clearInterval(this.options.map_visible))},c=function(){var e=this,i=t("."+this.options.targets_prefix+"distance").val();i&&(i=1e3*i),i=i||this.options.distanceWidgetRadius;var o=new google.maps.Circle({center:this.options.map_options.center,radius:i,strokeColor:"#005DE0",strokeOpacity:.8,strokeWeight:2,fillColor:"#005DE0",fillOpacity:.25,map:this.options.map}),n=function(){o.setEditable(!0)},s=function(){o.setEditable(!1)};if(""!=e.options.targets_prefix){var a=t("."+e.options.targets_prefix+"distance");a.length>0&&a.on("change keyup",function(){l.call(e,function(){var t=1e3*parseFloat(a.val());o.setRadius(t||0),e.options.map.fitBounds(o.getBounds())},400)})}return google.maps.event.addListener(o,"radius_changed",function(){e.options.location_components.distance=Math.round(o.getRadius())/1e3,e.updateFields("distance")}),google.maps.event.addListener(o,"mouseover",n),google.maps.event.addListener(o,"mouseout",s),o},u=function(){if(1==this.options.map_rendered)return this.resizeMap(),o;var e=this;if(this.options.map_options.zoom=this.options.zoom,this.options.map_options.center=new google.maps.LatLng(this.options.latitude,this.options.longitude),this.options.map_options.mapTypeId=google.maps.MapTypeId[this.options.mapTypeId],o===this.options.map||null==this.options.map)this.options.map=o!==t.fn.gmap3?t("#"+this.options.map_id).gmap3({map:{options:this.options.map_options}}).gmap3("get"):new google.maps.Map(t("#"+this.options.map_id).get(0),this.options.map_options);else{var i=this.options.map_id;this.options.map_id=t(this.options.map.getDiv()).attr("id"),t("#"+i).replaceWith(t("#"+this.options.map_id))}this.options.geocoder=new google.maps.Geocoder;var n={position:this.options.map_options.center,draggable:!0,raiseOnDrag:!0,map:this.options.map,labelContent:this.options.text.you_are_here,labelAnchor:new google.maps.Point(0,0),labelClass:this.options.markerLabelClass,labelStyle:{opacity:1}};if("styled"==this.options.markerType&&"function"==typeof StyledMarker){var s=new StyledIcon(StyledIconTypes.BUBBLE,{color:"#51A351",fore:"#ffffff",text:this.options.text.you_are_here});n.styleIcon=s,this.options.marker=new StyledMarker(n)}else this.options.marker="labeled"==this.options.markerType&&"function"==typeof MarkerWithLabel?new MarkerWithLabel(n):new google.maps.Marker(n);var a=t("#"+this.options.userInputId).text();if(this.options.isElementInput&&(a=t("#"+this.options.userInputId).val()),""!=a)this.geocodeLookup("address",a,!0);else if(""!=this.options.targets_prefix){var r=parseFloat(t("."+this.options.targets_prefix+"latitude").val()),d=parseFloat(t("."+this.options.targets_prefix+"longitude").val()),p=t("."+this.options.targets_prefix+"distance").val();p&&p>0&&(this.options.distanceWidgetRadius=parseFloat(p)),r&&""!=r&&d&&""!=d&&e.geocodeLookup("latLng",new google.maps.LatLng(r,d))}if(this.options.distanceWidget){switch(this.options.distanceWidgetType){case"circle":default:this.options.distanceArea=c.call(this)}this.options.distanceArea.bindTo("center",this.options.marker,"position")}google.maps.event.addListener(this.options.marker,"dragend",function(){e.geocodeLookup("latLng",e.options.marker.getPosition())}),google.maps.event.addListener(this.options.map,"click",function(t){e.options.marker.setPosition(t.latLng),e.geocodeLookup("latLng",t.latLng)});var u=0;google.maps.event.addListener(this.options.map,"bounds_changed",function(){l.call(e,function(){if(u++,u>1){var i=e.options.map.getBounds(),o=i.getNorthEast(),n=i.getSouthWest();e.options.location_components.ne_lat=+o.lat().toFixed(8),e.options.location_components.ne_lng=+o.lng().toFixed(8),e.options.location_components.sw_lat=+n.lat().toFixed(8),e.options.location_components.sw_lng=+n.lng().toFixed(8),e.updateFields("bounds");var s=t.Event(e.options.event_viewport_change);e.element.trigger(s,e.options.location_components),"function"==typeof e.options.onViewportChanged&&e.options.onViewportChanged.call(e,e.options.event_viewport_change)}},300,e.options.event_viewport_change)}),this.options.map_rendered=!0},h=function(t,e){e=e?e:t.location,this.options.marker.setPosition(e),t.viewport.extend(e),this.options.map.fitBounds(this.options.distanceWidget?this.options.distanceArea.getBounds():t.viewport)},f=function(e,i,o){var n=this;this.options.location_components.formatted_address=e;for(var s=0;s<o.length;s++){var a=o[s];a.types.indexOf("country")<0||(this.options.location_components.country=a.long_name,this.options.location_components.country_code=a.short_name),a.types.indexOf("administrative_area_level_1")<0||(this.options.location_components.region=a.long_name,this.options.location_components.region_code=a.short_name),a.types.indexOf("administrative_area_level_2")<0||(this.options.location_components.county=a.long_name,this.options.location_components.county_code=a.short_name),a.types.indexOf("locality")<0||(this.options.location_components.city=a.long_name),a.types.indexOf("sublocality")<0||(this.options.location_components.city_district=a.long_name),a.types.indexOf("postal_code")<0||(this.options.location_components.zip=a.long_name),a.types.indexOf("route")<0||(this.options.location_components.street=a.long_name),a.types.indexOf("street_number")<0||(this.options.location_components.street_number=a.long_name)}this.options.distanceWidget&&(this.options.location_components.distance=Math.round(this.options.distanceArea.getRadius())/1e3),"object"==typeof i&&(this.options.location_components.latitude=+i.lat().toFixed(8),this.options.location_components.longitude=+i.lng().toFixed(8)),t("body").find("#"+n.element.attr("id")).val(this.options.location_components.formatted_address).trigger("keyup"),"modal"!=this.options.mode&&l.call(this,function(){n.updateFields();var e=t.Event(n.options.event_success);n.element.trigger(e,n.options.location_components),"function"==typeof n.options.onSuccess&&n.options.onSuccess.call(n,n.options.event_success)},300,n.options.event_success)},m=function(){if("undefined"!=t.fn.typeahead){var e=this;t("#"+this.options.userInputId).attr("autocomplete","off"),o!==t.fn.typeahead&&t("#"+this.options.pickerInputId).typeahead({source:function(i,o){var n={};n.address=i,n.language=e.options.language,e.options.geocoder.geocode(n,function(i,n){t("#"+e.options.userInputId+"_error").html(""),n==google.maps.GeocoderStatus.OK&&o(t.map(i,function(t){return t.formatted_address}))})},updater:function(t){return e.geocodeLookup("address",t),t},minLength:3,items:this.options.maxResultShow})}},g=function(){var i=this;"modal"==this.options.mode?(this.element.on("focus click",function(){t("#"+i.options.userInputId+"_modal").modal("show")}),t("#"+this.options.userInputId+"_edit").on("click",function(){t("#"+i.options.userInputId+"_modal").modal("show")}),t("#"+this.options.userInputId+"_modal").on("shown",function(){i.resizeMap();var e=t.Event(i.options.event_open_modal);i.element.trigger(e,i.options.location_components),"function"==typeof i.options.onOpenModal&&i.options.onOpenModal.call(i,i.options.event_open_modal)}),t("#"+this.options.userInputId+"_ok").on("click",function(e){l.call(this,function(){var n=i.options.location_components.formatted_address;if(o===n||""==n)return e.preventDefault(),alert(i.options.text.set_your_address),o;i.options.isElementInput&&"object"==typeof i.options.location_components&&t("body").find("#"+i.element.attr("id")).val(i.options.location_components.formatted_address).trigger("keyup"),i.updateFields();var s=t.Event(i.options.event_success);i.element.trigger(s,i.options.location_components),"function"==typeof i.options.onSuccess&&i.options.onSuccess.call(i,i.options.event_success)},300,i.options.event_success)}),t("#"+this.options.userInputId+"_modal").on("click",'[data-dismiss="modal"]',function(){var e=t.Event(i.options.event_close_modal);i.element.trigger(e,i.options.location_components),"function"==typeof i.options.onCancelModal&&i.options.onCancelModal.call(i,i.options.event_close_modal)})):this.options.map_visible=e.setInterval(p.call(this),300),t("#"+this.options.pickerInputId).on("keydown",function(e){13==e.keyCode&&i.geocodeLookup("address",t("body").find("#"+i.options.pickerInputId).val())}),t("#"+this.options.userInputId+"_search").on("click",function(){i.geocodeLookup("address",t("body").find("#"+i.options.pickerInputId).val())})},v=function(){this.others_opts={event_initialized:n+"_initialized",event_open_modal:n+"_open_modal",event_close_modal:n+"_close_modal",event_success:n+"_success",event_viewport_change:n+"_viewport_change",$events:t("<a/>"),$related:null,map_rendered:!1,userInputId:null,aPicker:null,elementClass:null,isElementInput:!0,pickerInputId:null,geocoder:null,globalCluster:null,marker:null,location_components:{country:"",country_code:"",county:"",county_code:"",region:"",region_code:"",city:"",city_district:"",zip:"",street:"",street_number:"",latitude:"",longitude:"",formatted_address:"",ne_lat:"",ne_lng:"",sw_lat:"",sw_lng:""},map_visible:null,element:null,initialized:!1},this.options=t.extend({},a)};v.prototype={init:function(e){if(!this.options.initialized){var i=this.element,o=i.data();t.extend(this.options,e,o,this.others_opts),this.options.pickerInputId=this.options.userInputId=this.id=i.attr("id"),""==this.options.userInputId&&(this.options.userInputId=r()),this.element.is('input[type="text"],textarea')||(this.options.isElementInput=!1,this.options.pickerInputId=this.options.userInputId=r(),this.options.targets_prefix||(this.options.targets_prefix=this.options.userInputId+"_location_"),elementClass=this.options.targets_prefix+"formatted_address",this.element.addClass(elementClass)),"modal"==this.options.mode&&(this.options.pickerInputId=this.options.userInputId+"_addresspicker"),this.options.aPicker=this.options.userInputId+"_apicker",this.options.map_id=this.options.userInputId+"_map_canvas",this.options.mapTypeId=/ROADMAP|HYBRID|TERRAIN|SATELLITE/i.test(this.options.mapType)?this.options.mapType.toUpperCase():"ROADMAP",d.call(this),u.call(this),m.call(this),g.call(this),this.options.initialized=!0;var n=t.Event(this.options.event_initialized);this.element.trigger(n,this.options.location_components),"function"==typeof this.options.onInit&&this.options.onInit.call(this,this.options.event_initialized)}},geocodeLookup:function(e,i,n){var s=!1,a=this;"string"==typeof i&&"latLng"==e&&(i=i.split(","),i=new google.maps.LatLng(i[0],i[1])),"latLng"==e&&(s=i),n=o!==n?n:!0;var r={};r[e]=i,r.language=this.options.language,this.options.geocoder.geocode(r,function(i,o){if(t("#"+a.options.userInputId+"_error").html(""),o==google.maps.GeocoderStatus.OK){if(h.call(a,i[0].geometry,s),"modal"==a.options.mode&&i[0]&&t("body").find("#"+a.options.pickerInputId).val(i[0].formatted_address),n)if(i[0]){var r=i[0].geometry.location;"latLng"==e&&(r=s),f.call(a,i[0].formatted_address,r,i[0].address_components)}else t("#"+a.options.userInputId+"_error").html(a.options.text.genericerror);return!0}return n&&("address"==e?t("#"+a.options.userInputId+"_error").html(a.options.text.noresults):(t("#"+a.options.userInputId+"_error").html(a.options.text.toofar),f.call(a,"","",""))),!1})},updateFields:function(e){var i=this,n=[];if(o!==e&&("bounds"==e?n=["sw_lat","sw_lng","ne_lat","ne_lng"]:e instanceof Array?n=e:"string"==typeof e&&(n=[e])),this.options.targets_prefix||this.options.cssSelectorTarget){var s=t();this.options.targets_prefix&&(s=s.add(t("body").find('[class^="'+this.options.targets_prefix+'"],[class*=" '+this.options.targets_prefix+'"]'))),this.options.cssSelectorTarget&&(s=s.add(t("body").find(this.options.cssSelectorTarget))),s.each(function(){var e=t(this);t.each(i.options.location_components,function(s){return n.length>0&&n.indexOf(s)<0?!0:e.hasClass(i.options.targets_prefix+s)||e.hasClass(s)?(e.is('input:not([type="radio"]), textarea')?(e.val(i.options.location_components[s]),"function"==t.fn.validationEngine&&e.validationEngine("validate")):e.text(i.options.location_components[s]),o):!0})})}},getMap:function(){return this.options.map},getAddress:function(){return this.options.location_components},resizeMap:function(e,i){var n=this;l(function(){var s,a=t("#"+n.options.map_id).closest(".map_container"),r=a.parent(),l=r.height(),d=r.width();a.css("height",l),a.css("width",d),s=o!==e&&o!==i?new google.maps.LatLng(e,i):n.options.map.getCenter(),google.maps.event.trigger(n.options.map,"resize"),n.options.map.setCenter(s)},300)},destroy:function(){this.element.data(s,null)}},t.fn[n]=function(e){var i,a;if(this.length<=0)return this;if(this.data(s)instanceof v||this.data(s,new v(this)),a=this.data(s),a.element=this,o===e||"object"==typeof e)"function"==typeof a.init&&a.init(e);else{if("string"==typeof e&&"function"==typeof a[e])return i=Array.prototype.slice.call(arguments,1),a[e].apply(a,i);t.error("Method "+e+" does not exist on jQuery."+n)}}}(jQuery,window,document);