/*
* @name			functions for repeatable feature
* @version		0.0.1
* @package		jForms
* @copyright	G. Tomaselli
* @author		Girolamo Tomaselli - http://bygiro.com - girotomaselli@gmail.com
* @license		GNU GPL v3 or later
*/
;function editIt(e,t,i,a){var r,n,o=e.closest("[data-repeatable]").attr("data-repeatable"),d=void 0!==window[o].sample_item?window[o].sample_item:{},u={},l=!1,s=!1,f=!1,i=1!=i?!1:!0;return jQuery.isPlainObject(t)?(void 0!==t.id&&t.id>0&&(u=e.find('[data-item-id="'+t.id+'"]').data("item")),d=jQuery.extend({},d,u,t),t=t.id):(t=t>0?t:0,t>0&&(u=e.find('[data-item-id="'+t+'"]').data("item")),d=jQuery.extend({},d,u)),(0>=t||i)&&(l=!0,void 0===window[o].last_id&&(window[o].last_id=0),void 0===window[o].list_counter&&(window[o].list_counter=0),d.id=t=window[o].last_id+1,d.list_counter=window[o].list_counter+1),d.isNew=l,r=jQuery("#"+o+"_forms").find('[data-item-id="'+t+'"]'),void 0!==r&&r.length>0||(d=findParents(e,d),r=createForm(o,d),s=!0,f=!0),n=jQuery("#fset_modal_form .modal-body"),f&&deactivateEditors(n)&&n.children().remove(),r.appendTo(n),jQuery("#"+o+"_forms").find('[data-item-id="'+t+'"]').remove(),s&&setValues(n,d),f&&enablePlugins(n),checkOptionsForUniqueness(n,o,t),!0}function createForm(e,t){var i=jQuery("#tmpl_"+window[e].tmpl_form+"_form").html(),a=null;void 0!==window[e].doT_config&&(a=window[e].doT_config);var r=doT.template(i,a);return void 0===window[e].file_free&&(window[e].file_free=jQuery(jQuery("#tmpl_"+window[e].tmpl_form+"_form").html()).find('input[type="file"]').length<=0),jQuery(i).find('input[type="text"]').each(function(){var e=getFieldName(jQuery(this));"string"==typeof t[e]&&(t[e]=t[e].replace(/"/g,"&quot;"))}),form=r(t),form=form.replace(RegExp("textareaname","g"),"textarea name"),jQuery(form)}function checkUniqueItem(e,t){if(void 0===window[e].unique)return!0;removeItemsFromUniqueList(e,[t]);var i=checkItemsUniqueness(e,[t]),a=window[e].popup;return 1==i.length?!0:(highlightUniqueFields(jQuery(a),window[e].uniqueRules),!1)}function checkOptionsForUniqueness(e,t,i){if(void 0===window[t].unique)return!0;var a={};jQuery.each(window[t].uniqueRules,function(e,r){if(1!=r.length)return!0;a[e]=[];for(var n in window[t].uniqueElements[e]){var o=window[t].uniqueElements[e][n];o.id!=i&&a[e].push(o[r[0]])}}),e.find('select,input[type="radio"],input[type="checkbox"]').each(function(){var e=getFieldName(jQuery(this));if(""==e)return!0;for(var i in window[t].uniqueRules)e==i&&(jQuery(this).is("select")?jQuery(this).find("option").each(function(){var e=jQuery(this).attr("value");jQuery.isArray(a[i])&&jQuery.inArray(e,a[i])>=0?jQuery(this).attr("disabled","disabled").prop("disabled",!0):jQuery(this).removeAttr("disabled").prop("disabled",!1)}):jQuery(this).is('[type="radio"]')||jQuery(this).is('[type="checkbox"]'))})}function array_flip_withId(e){var t={};for(v in e){var i=e[v];t[i.id]=v}return t}function removeItemsFromUniqueList(e,t){return void 0===window[e].unique?!0:void jQuery.each(window[e].uniqueRules,function(i){for(var a=array_flip_withId(window[e].uniqueElements[i]),r=0;r<t.length;r++)void 0!==a[t[r].id]&&delete window[e].uniqueElements[i][a[t[r].id]]})}function getFieldName(e){var t,i="",a=e.attr("name");return"string"!=typeof a?"":(t=a.split("["),i=t.pop().replace("]",""),(void 0===i||""==i)&&(i=t.pop().replace("]","")),i)}function highlightUniqueFields(e,t){var i="This field must be UNIQUE, you already have an item with this value, change value";e.find("select,textarea,input").each(function(){var e=this,a=getFieldName(jQuery(this));jQuery.each(t,function(t,r){jQuery.inArray(a,r)<0||(void 0!==jQuery.fn.validationEngine?jQuery(e).validationEngine("showPrompt",i,"red","centerRight",!0):alert(a+": "+i))})})}function enablePlugins(e){void 0!==jQuery.fn.tagsManagerByGiro&&e.find("input[tgman]").tagsManagerByGiro(),"function"==typeof dateTimePickerEnabler&&dateTimePickerEnabler(e),void 0!==jQuery.fn.timepickerByGiro&&e.find("input.timepickerByGiro").each(function(){var e=jQuery(this);e.timepickerByGiro()}),void 0!==jQuery.fn.multiselectByGiro&&e.find(".multiselect").multiselectByGiro(),"function"==typeof colorpickerEnabler&&colorpickerEnabler(e),"function"==typeof addressPickerEnabler&&addressPickerEnabler(e),"function"==typeof clonerEnabler&&clonerEnabler(e),radiosInit(e),e.find('[data-toggle="popover"]').popover({html:!0}).on("hidden",function(e){e.stopPropagation()}),e.find(".hasTooltip").tooltip({html:!0}).on("hidden",function(e){e.stopPropagation()}),void 0!==jQuery.fn.validationEngine&&jQuery("#fset_modal_form").validationEngine(),"function"==typeof jQuery.fn.condRules&&e.condRules()}function activateEditors(e){{var t={};e.find("textarea[data-editor]").each(function(){var e=jQuery(this).attr("data-editor");if(jQuery(this).addClass("editor_"+e),void 0!==window.editors_repeatable&&"function"==typeof window.editors_repeatable[e]){if(void 0!==t[e])return!0;var i='#fset_modal_form .modal-body textarea[data-editor="'+e+'"]';window.editors_repeatable[e](i)}})}}function deactivateEditors(e){if("undefined"!=typeof tinyMCE||"undefined"!=typeof tinymce){"undefined"!=typeof tinyMCE?tinyMCE.triggerSave():tinymce.triggerSave();for(var t=[],i=tinymce.editors.length-1;i>=0;i--)t.push(tinymce.editors[i].id)}return e.find("textarea[data-editor]").each(function(){var e=jQuery(this).attr("id"),i=jQuery(this).attr("data-editor");switch(i){case"codemirror":void 0!==Joomla.editors.instances[e]&&(Joomla.editors.instances[e].toTextArea(),delete Joomla.editors.instances[e]);break;case"jce":case"tinymce":"undefined"!=typeof tinyMCE&&(t.indexOf(e)<0||(tinyMCE.execCommand("mceFocus",!1,e),tinyMCE.execCommand("mceRemoveControl",!1,e),tinyMCE.execCommand("mceRemoveEditor",!1,e)))}}),!0}function setValues(e,t){e.find('select,input[type="radio"],input[type="checkbox"]').each(function(){var e=jQuery(this),i=getFieldName(e);if(""==i)return!0;if(val=t[i],e.is("select")){if(e.hasClass("multiselect")&&"true"==e.attr("data-allow-custom-values")){var a=val;jQuery.isArray(a)||(a=[a]),e.find("option").each(function(){var t=e.attr("value");if(""==t)return!0;var i=a.indexOf(t);0>i||a.splice(i,1)}),jQuery.each(a,function(t,i){e.append('<option value="'+i+'">'+i+"</option>")})}return e.val(val),!0}"boolean"==typeof t[i]&&(val=0,t[i]&&(val=1));var r=e.val();if(val instanceof Array)for(var n=0;n<val.length;n++)val[n]=""+val[n];(val instanceof Array||val!=r)&&jQuery.inArray(""+r,val)<0?e.prop("checked",!1).removeAttr("checked"):e.prop("checked",!0).attr("checked","checked")})}function saveIt(e,t){var i=e.closest("[data-repeatable]").attr("data-repeatable"),a=!1,r=window[i].popup,n=jQuery(r+" .modal-body"),t=t>0?t:!1,o=jQuery("#tmpl_"+window[i].tmpl_item+"_item").html(),d=null;void 0!==window[i].doT_config&&(d=window[i].doT_config);var u=doT.template(o,d);deactivateEditors(n);var l,s=jQuery(r).find("[data-item-id]"),f=s.serializeObject(),c=parseInt(s.attr("data-item-id"))||0,m="true"==s.attr("data-item-isnew")?!0:!1,y={};if(y.id=c,y.isNew=m,jQuery.each(f,function(e,t){if(e.indexOf("-raw_editor")>=0&&void 0!==window.dataFiles_loaded){var i=s.find('[name="'+e+'"]').attr("id");void 0!==window.dataFiles_loaded[i]&&(window.dataFiles_loaded[i]=t)}if(e.indexOf("jform[")<0)return!0;if(e.indexOf("[")>=0){var a=e.split("["),e=a.pop().replace("]","");(void 0===e||""==e)&&(e=a.pop().replace("]",""))}return"remove_item"==e?!0:void(y[e]=t)}),y.id>0){if(!checkUniqueItem(i,y))return!1;if(l=e.find('[data-item-id="'+y.id+'"]'),l.length>0)y=jQuery.extend({},l.data("item"),y),a=u(y),a=jQuery(a).data("item",y),l.replaceWith(a),void 0!==jQuery.fn.jListByGiro&&void 0!==jQuery("#"+i+"_list").data("plugin_jListByGiro")&&jQuery("#"+i+"_list").jListByGiro("query",{task:"update",where:["id = "+y.id],justOne:!0,set:y});else{if(y.list_counter=window[i].list_counter+1,a=u(y),a=jQuery(a).data("item",y),t){var p=e.find('[data-item-id="'+parseInt(t)+'"]');p.length>0?p.after(a):e.append(a)}else e.append(a);void 0!==jQuery.fn.jListByGiro&&void 0!==jQuery("#"+i+"_list").data("plugin_jListByGiro")&&jQuery("#"+i+"_list").jListByGiro("add",y,!1),window[i].last_id=c=y.id,window[i].list_counter++}s.appendTo("#"+i+"_forms")}return y.isNew&&(window[i].file_free||e.find('[data-item-id="'+y.id+'"] .btn-copy').addClass("disabled"),updateListOrdering(e)),deactivateEditors(n)&&n.children().remove(),!0}function removeIt(e,t){var i,a,r=e.closest("[data-repeatable]").attr("data-repeatable"),n=jQuery("#tmpl_"+window[r].tmpl_form+"_form").html(),o=[],d="ALL"===t?!0:!1;if(i=jQuery("<div/>").html(n),i.find("input.remove_item").val(1),i.find("input,select,textarea").not("input.remove_item").remove(),n=i.html(),d)e.find("[data-item-id]").each(function(){a=jQuery(this).attr("data-item-id"),a&&o.push({id:a})}),jQuery("#"+r+"_forms").empty().html('<input type="hidden" name="jform['+r+'_remove_all]" value="1" />'),void 0!==jQuery.fn.jListByGiro&&void 0!==jQuery("#"+r+"_list").data("plugin_jListByGiro")?jQuery("#"+r+"_list").jListByGiro("deleteAll"):e.find("[data-item-id]").remove();else{o.push({id:t});var u=doT.template(n);i=u({id:t}),jQuery("#"+r+"_forms").find('[data-item-id="'+t+'"]').remove(),jQuery("#"+r+"_forms").append(i),void 0!==jQuery.fn.jListByGiro&&void 0!==jQuery("#"+r+"_list").data("plugin_jListByGiro")?jQuery("#"+r+"_list").jListByGiro("query",{task:"delete",where:["id = "+t],justOne:!0}):e.find('[data-item-id="'+t+'"]').remove()}jQuery.isArray(o)&&o.length>0&&removeItemsFromUniqueList(r,o)}function initList(e,t){var i=e.closest("[data-repeatable]").attr("data-repeatable");if(void 0!==window[i]){window[i]=window[i]||{};var a,r=jQuery("#tmpl_"+window[i].tmpl_item+"_item").html(),n=null;if(void 0!==r){void 0!==window[i].doT_config&&(n=window[i].doT_config);var a=doT.template(r,n);t.templater=a}if(t.values=checkItemsUniqueness(i,t.values),t.values=checkItemsIds(i,t.values),void 0!==jQuery.fn.jListByGiro&&void 0!==t.jListByGiro&&t.jListByGiro)jQuery("#"+i+"_list").jListByGiro(t);else{if(void 0===a)return;jQuery.each(t.values,function(t,i){if("object"!=typeof i||null==i)return!0;var r=a(i);r=jQuery(r).data("item",i),e.append(r)})}void 0!==t.formValues&&jQuery.isArray(t.formValues)&&t.formValues.length>0&&jQuery.each(t.formValues,function(t,i){editIt(e,i),saveIt(e)}),updateListOrdering(e)}}function updateListOrdering(e){var t=[];(void 0===e.attr("data-repeatable")||0==e.attr("data-repeatable"))&&(e=e.closest("[data-repeatable]"));var i=e.attr("data-repeatable");void 0!==jQuery.fn.jListByGiro&&void 0!==jQuery("#"+i+"_list").data("plugin_jListByGiro")||e.find("."+i+"_list").children().each(function(){t.push(jQuery(this).attr("data-item-id"))}),jQuery("#"+i+"_list_ordering").val(t.join())}function checkItemsIds(e,t){var i=[],a=0,r=[];jQuery.each(t,function(n,o){if("object"!=typeof o||null==o)return!0;a++,window[e].list_counter=t[n].list_counter=a;var d=parseInt(o.id);0>d?r.push(n):i.push(d)});var n=parseInt(findMax(i))||0;return jQuery.each(r,function(e,i){var a=t[i];return"object"!=typeof a||null==a?!0:(n++,void(t[i].id=n))}),window[e].last_id=n,window[e].list_counter=a,t}function checkItemsUniqueness(e,t){if(void 0===window[e])return t;if(void 0===window[e].uniqueElements&&void 0===window[e].uniqueRules&&(window[e].uniqueElements={},window[e].uniqueRules={},void 0!==window[e].unique)){var i=window[e].unique;jQuery.each(i,function(t,i){window[e].uniqueRules[i]=i.split("."),window[e].uniqueElements[i]={}})}return jQuery.each(t,function(i,a){return"object"!=typeof a||null==a?!0:void(void 0!==window[e].unique&&jQuery.each(window[e].uniqueRules,function(r,n){for(var o=[],d=0;d<n.length;d++)void 0!==a[n[d]]&&""!=a[n[d]]&&o.push(""+a[n[d]]);o.length>0&&(void 0===window[e].uniqueElements[r][""+o]?window[e].uniqueElements[r][""+o]=a:t.splice(i,1))}))}),t}function findMax(e){for(var t=-1/0,i=0,a=e.length;i!=a;++i)e[i]>t&&(t=e[i]);return t}function checkItemForm(e){var t=(e.closest("[data-repeatable]").attr("data-repeatable"),"#fset_modal_form .modal-body"),i=!1,a=[],r=jQuery(t).find("input, select, textarea");return 0==r.length?!0:(r.each(function(){var e;if(jQuery(this).is('[type="radio"]')){var r=jQuery(this).attr("name");e=!jQuery(t).find('[name="'+r+'"]').validationEngine("validate")}else e=!jQuery(this).validationEngine("validate");if(a.push(e),!i&&!e){var n={target:jQuery(this),topoffset:80,parent:t};scrollToElement(n)}}),a.AllValuesSame()&&a.AllValuesSame()&&a[0]?!0:!1)}function findParents(e,t){return e.parents("[data-item-id]").each(function(e){0==e&&(e=""),t["pid"+e]=jQuery(this).attr("data-item-id")}),t}jQuery(document).ready(function(){jQuery("#fset_modal_form").appendTo("body"),jQuery("[data-repeatable]").on("click",".btn-edit:not(.disabled)",function(){var e=jQuery(this).closest("[data-repeatable]"),t=e.attr("data-repeatable"),i=e.find("."+t+"_list"),a=jQuery(this).closest("[data-item-id]").attr("data-item-id");jQuery("#fset_modal_form").attr("data-listname",t).attr("data-listid",e.attr("id")),editIt(i,a),jQuery("#fset_modal_form").modal("show"),"function"==typeof scrollToElement&&scrollToElement({target:jQuery("#fset_modal_form .modal-body"),parent:jQuery("#fset_modal_form .modal-body")})}),jQuery("[data-repeatable]").on("click",".btn-copy:not(.disabled)",function(){var e=jQuery(this).closest("[data-repeatable]"),t=e.attr("data-repeatable"),i=e.find("."+t+"_list"),a=jQuery(this).closest("[data-item-id]").attr("data-item-id");jQuery("#fset_modal_form").attr("data-listname",t).attr("data-listid",e.attr("id")),editIt(i,a,!0),saveIt(i,a),updateListOrdering(i)}),jQuery("[data-repeatable]").on("click",".btn-new:not(.disabled)",function(){var e=jQuery(this).closest("[data-repeatable]"),t=e.attr("data-repeatable"),i=e.find("."+t+"_list");jQuery("#fset_modal_form").attr("data-listname",t).attr("data-listid",e.attr("id")),editIt(i),jQuery("#fset_modal_form").modal("show"),"function"==typeof scrollToElement&&scrollToElement({target:jQuery("#fset_modal_form .modal-body"),parent:jQuery("#fset_modal_form .modal-body")})}),jQuery("[data-repeatable]").on("click",".btn-delete:not(.disabled)",function(){var e=jQuery(this).closest("[data-repeatable]"),t=e.attr("data-repeatable"),i=e.find("."+t+"_list"),a=!0;if(jQuery("#security_lock_delete_"+e.attr("id")).is(":checked")&&(a=confirm(Joomla.JText._("PLG_JDOM_ALERT_ASK_BEFORE_REMOVE"))),a){var r=jQuery(this).closest("[data-item-id]").attr("data-item-id");removeIt(i,r),updateListOrdering(i)}}),jQuery("[data-repeatable]").on("click",".btn-deleteAll:not(.disabled)",function(){var e=jQuery(this).closest("[data-repeatable]"),t=e.attr("data-repeatable"),i=e.find("."+t+"_list");confirm(Joomla.JText._("PLG_JDOM_ALERT_ASK_BEFORE_REMOVE"))&&(removeIt(i,"ALL"),updateListOrdering(i))}),jQuery(".modal.popupform").on("click",'[data-dismiss="modal"]',function(){var e=jQuery(this).closest("[data-listid]").attr("data-listid"),t=jQuery("body").find("#"+e),i=t.attr("data-repeatable"),a=t.find("."+i+"_list"),r=jQuery("#fset_modal_form .modal-body").find("[data-item-id]").attr("data-item-id");editIt(a,r,!1,!1)&&saveIt(a)}),jQuery(".modal.popupform").on("click",".btn-apply",function(){var e=!1,t=jQuery(this).closest("[data-listid]").attr("data-listid"),i=jQuery("body").find("#"+t),a=i.attr("data-repeatable"),r=i.find("."+a+"_list");e=void 0!==jQuery.fn.validationEngine?checkItemForm(r):!0,e&&saveIt(r)&&jQuery("#fset_modal_form").modal("hide")}),jQuery("#fset_modal_form").on("hide",function(){jQuery("body").find(".popover.in").remove(),jQuery("form").each(function(){jQuery(this).data("plugin_postMaxSize")&&jQuery(this).postMaxSize("check")})}),jQuery("#fset_modal_form .modal-body").on("scroll",function(){jQuery("body").find(".popover.in").remove()})}),jQuery(document).on("focusin",function(e){jQuery(e.target).closest(".mce-window").length&&e.stopImmediatePropagation()});